<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Diario | Marketplace Manager</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/supabase.js"></script>
  <script src="assets/app.js"></script>

  <style>
    body { font-family: system-ui, Arial; margin:0; background:#0b1020; color:#e2e8f0; }
    .layout { display:flex; }
    .content { padding: 18px; width: 100%; }
    h1 { margin: 0 0 10px; font-size: 20px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 12px; }
    .card { background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 14px; }
    .muted { opacity:.75; font-size: 13px; }
    .row { display:flex; gap: 10px; align-items:center; flex-wrap: wrap; }
    label { display:block; margin-top: 10px; font-size: 13px; opacity: .9; }
    input, textarea, select {
      width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.25); color:#e2e8f0; box-sizing:border-box;
    }
    textarea { min-height: 92px; resize: vertical; }
    .btn {
      padding: 10px 12px; border-radius: 12px;
      border:1px solid rgba(99,102,241,0.5);
      background: rgba(99,102,241,0.18);
      color:#e2e8f0;
      cursor:pointer;
    }
    .btn:hover { background: rgba(99,102,241,0.26); }
    .btn2 {
      padding: 10px 12px; border-radius: 12px;
      border:1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      color:#e2e8f0;
      cursor:pointer;
    }
    .btn2:hover { background: rgba(255,255,255,0.09); }
    .pill {
      display:inline-block; padding: 6px 10px; border-radius: 999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      font-size: 12px;
    }
    .log {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      padding: 10px;
      min-height: 120px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="layout">
    <div id="sidebar-host"></div>

    <main class="content">
      <h1>üìÖ Diario</h1>
      <div class="muted" id="subtitle"></div>

      <div class="grid" style="margin-top:12px;">
        <section class="card">
          <div style="font-weight:800;">üéØ Asignaci√≥n de hoy</div>
          <div class="muted" id="asigHint">Cargando...</div>

          <div style="margin-top:10px;" id="asigBox"></div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,0.12); margin: 12px 0;">

          <div class="row">
            <button class="btn" id="btnTakeAcc">Tomar cuenta Facebook</button>
            <span class="pill" id="accStatus">Cuenta: -</span>
          </div>

          <div style="margin-top:10px;" class="muted">
            Esto marca una cuenta <code>disponible</code> como <code>ocupada</code> y setea <code>ocupada_por</code>.
          </div>
        </section>

        <section class="card">
          <div style="font-weight:800;">üßæ Registrar publicaci√≥n</div>
          <div class="muted">Guarda un registro en <code>marketplace_actividad</code>.</div>

          <label>Categor√≠a</label>
          <select id="categoriaSelect"></select>

          <label>T√≠tulo</label>
          <input id="titulo" />

          <label>Descripci√≥n</label>
          <textarea id="descripcion"></textarea>

          <label>Etiquetas usadas (coma separada)</label>
          <input id="etiquetas" placeholder="ropa, oferta, envio" />

          <label>Link publicaci√≥n (marketplace)</label>
          <input id="link" placeholder="https://facebook.com/marketplace/item/..." />

          <div class="row" style="margin-top:12px;">
            <button class="btn" id="btnSave">Guardar actividad</button>
            <button class="btn2" id="btnClear">Limpiar</button>
          </div>

          <div style="margin-top:12px;">
            <div style="font-weight:700; margin-bottom:6px;">üñ•Ô∏è Logs</div>
            <div class="log" id="log"></div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    const s = requireSession();
    loadSidebar("diario");

    const sb = window.supabaseClient;
    const $ = (id) => document.getElementById(id);

    const today = fmtDateISO(new Date());
    $("subtitle").textContent = `Hoy: ${today} | Usuario: ${s.usuario} | Rol: ${s.rol}`;

    function log(line) {
      const el = $("log");
      const ts = new Date().toLocaleTimeString();
      el.textContent += `[${ts}] ${line}\n`;
      el.scrollTop = el.scrollHeight;
    }

    function setAccStatus(text) {
      $("accStatus").textContent = "Cuenta: " + (text || "-");
    }

    async function loadCategorias() {
      const { data, error } = await sb
        .from("categoria")
        .select("id,nombre,mensaje,csv_nombre")
        .order("nombre", { ascending: true });

      if (error) {
        log("‚ùå categorias error: " + error.message);
        return;
      }

      const sel = $("categoriaSelect");
      sel.innerHTML = "";
      for (const c of (data || [])) {
        const opt = document.createElement("option");
        opt.value = c.nombre; // simple: guardamos nombre en actividad (tu esquema)
        opt.textContent = c.nombre;
        opt.dataset.mensaje = c.mensaje || "";
        sel.appendChild(opt);
      }

      if (sel.options.length) {
        // auto-cargar mensaje base en descripci√≥n si est√° vac√≠a
        const msg = sel.options[sel.selectedIndex].dataset.mensaje || "";
        if (!$("descripcion").value.trim() && msg) $("descripcion").value = msg;
      }
    }

    $("categoriaSelect").addEventListener("change", () => {
      const sel = $("categoriaSelect");
      const msg = sel.options[sel.selectedIndex]?.dataset?.mensaje || "";
      if (msg) {
        // no te sobreescribo si ya escribi√≥ algo
        if (!$("descripcion").value.trim()) $("descripcion").value = msg;
      }
    });

    async function loadAsignacionDeHoy() {
      $("asigHint").textContent = "Buscando asignaci√≥n...";
      $("asigBox").innerHTML = "";

      // buscamos asignaciones donde hoy est√© dentro del rango
      const { data, error } = await sb
        .from("usuarios_asignado")
        .select("id,usuario,fecha_desde,fecha_hasta,categoria,marketplace_daily,historia_daily,muro_daily,grupos_daily,asignado_por,created_at,updated_at")
        .eq("usuario", s.usuario);

      if (error) {
        $("asigHint").textContent = "Error cargando asignaci√≥n.";
        log("‚ùå asignado error: " + error.message);
        return;
      }

      const inRange = (data || []).filter(a => {
        // strings yyyy-mm-dd
        return (a.fecha_desde <= today && today <= a.fecha_hasta);
      });

      if (!inRange.length) {
        $("asigHint").textContent = "No ten√©s asignaci√≥n para hoy.";
        $("asigBox").innerHTML = `<div class="muted">Pedile al gerente que te asigne categor√≠a/rango.</div>`;
        return;
      }

      // si hay varias, mostramos todas
      $("asigHint").textContent = `Asignaciones activas hoy: ${inRange.length}`;
      const box = document.createElement("div");

      for (const a of inRange) {
        const div = document.createElement("div");
        div.style.marginTop = "10px";
        div.innerHTML = `
          <div class="pill">Categor√≠a: <strong>${escapeHtml(a.categoria)}</strong></div>
          <div class="muted" style="margin-top:8px;">
            Rango: ${escapeHtml(a.fecha_desde)} ‚Üí ${escapeHtml(a.fecha_hasta)}<br>
            Objetivos: marketplace=${escapeHtml(a.marketplace_daily)} | historia=${escapeHtml(a.historia_daily)} | muro=${escapeHtml(a.muro_daily)} | grupos=${escapeHtml(a.grupos_daily)}
          </div>
        `;
        box.appendChild(div);
      }

      $("asigBox").appendChild(box);
    }

    async function ensureCuentaActual() {
      // Si ya hay una cuenta ocupada por este usuario, la mostramos
      const { data, error } = await sb
        .from("cuentas_facebook")
        .select("id,email,nombre,estado,ocupada_por")
        .eq("ocupada_por", s.usuario)
        .eq("estado", "ocupada")
        .order("id", { ascending: true })
        .limit(1);

      if (error) {
        log("‚ùå cuentas check error: " + error.message);
        return;
      }
      if (data && data.length) {
        const acc = data[0];
        setAccStatus(acc.email || acc.nombre || ("id=" + acc.id));
      } else {
        setAccStatus("-");
      }
    }

    async function takeCuenta() {
      log("Tomando cuenta...");
      const result = await takeFacebookAccountFor(s.usuario);
      if (!result.ok) {
        log("‚ö†Ô∏è " + result.reason);
        return;
      }
      const acc = result.account;
      log(`‚úÖ Cuenta tomada: ${acc.email || acc.nombre || ("id=" + acc.id)}`);
      setAccStatus(acc.email || acc.nombre || ("id=" + acc.id));

      // registrar actividad de login (opcional; usando tu tabla usuarios_actividad)
      const { error } = await sb.from("usuarios_actividad").insert([{
        usuario: s.usuario,
        fecha_logueo: nowISO(),
        facebook_account_usada: acc.email || acc.nombre || String(acc.id),
        created_at: nowISO()
      }]);

      if (error) log("‚ö†Ô∏è usuarios_actividad insert: " + error.message);
    }

    async function saveActividad() {
      const categoria = $("categoriaSelect").value;
      const titulo = $("titulo").value.trim();
      const descripcion = $("descripcion").value.trim();
      const etiquetas = $("etiquetas").value.trim();
      const link = $("link").value.trim();

      if (!categoria) { log("‚ö†Ô∏è Falta categor√≠a."); return; }
      if (!titulo) { log("‚ö†Ô∏è Falta t√≠tulo."); return; }

      // mejor: usar cuenta ocupada actual si existe
      let facebookUsed = "-";
      const { data: acc, error: eAcc } = await sb
        .from("cuentas_facebook")
        .select("email,nombre,id")
        .eq("ocupada_por", s.usuario)
        .eq("estado", "ocupada")
        .limit(1);

      if (!eAcc && acc && acc.length) {
        facebookUsed = acc[0].email || acc[0].nombre || String(acc[0].id);
      }

      const payload = {
        usuario: s.usuario,
        facebook_account_usada: facebookUsed,
        fecha_publicacion: today, // en tu esquema es tipo fecha; si quer√©s datetime, cambiamos
        marketplace_link_publicacion: link || null,
        titulo,
        descripcion: descripcion || null,
        categoria,
        etiquetas_usadas: etiquetas || null,
        created_at: nowISO()
      };

      log("Insert marketplace_actividad...");
      const { error } = await sb.from("marketplace_actividad").insert([payload]);

      if (error) {
        log("‚ùå insert error: " + error.message);
        return;
      }

      log("‚úÖ Actividad guardada.");
    }

    function clearForm() {
      $("titulo").value = "";
      $("etiquetas").value = "";
      $("link").value = "";
      // descripci√≥n la dejo, porque suele ser template
      log("üßº Form limpio (parcial).");
    }

    $("btnTakeAcc").addEventListener("click", () => takeCuenta().catch(e => log("‚ùå " + e.message)));
    $("btnSave").addEventListener("click", () => saveActividad().catch(e => log("‚ùå " + e.message)));
    $("btnClear").addEventListener("click", clearForm);

    // init
    (async function init() {
      log("Init diario...");
      await loadCategorias();
      await loadAsignacionDeHoy();
      await ensureCuentaActual();
      log("Listo.");
    })();
  </script>
</body>
</html>
